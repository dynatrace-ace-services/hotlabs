{"version":13,"variables":[{"key":"tagKey","type":"csv","input":"dt.owner","multiple":false}],"tiles":{"2":{"type":"data","title":"Coverage of Tags","query":"fetch dt.entity.host\n| expand tags\n| filter isNotNull(tags)\n//| filter contains(tags, \"dt.\")\n| parse tags, \"LD:key':'\"\n| fieldsAdd key = if(isNotNull(tags) and isNull(key), tags, else:key)\n| summarize count(), by:{key, id}, alias: count\n| summarize count(), by:{key}, alias: count\n| sort count desc\n| limit 50","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualization":"categoricalBarChart","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxis":"key","categoryAxisLabel":"key","valueAxis":"count","valueAxisLabel":"count","scale":"absolute"}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"key"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"lineWrapIds":[["count"]],"columnWidths":{"[\"key\"]":278,"[\"lookup.entity.name\"]":208.1999969482422,"[\"lookup.id\"]":185.8000030517578,"[\"lookup.tags\"]":171.3937530517578,"[\"lookup.key\"]":115.70625305175781,"[\"count\"]":567,"[\"entity.name\"]":143.4652862548828,"[\"id\"]":182.1041717529297,"[\"tags\"]":346.3680725097656}}}},"3":{"type":"data","title":"Hosts without chosen tag","query":"fetch bizevents\n\n// get the prices\n| filter event.type == \"instance.spend\"\n\n// lookup for tag on the hosts\n| lookup \n [fetch dt.entity.host\n | fieldsAdd tagged = contains(toString(tags), $tagKey)\n | fieldsAdd tagged = not(isFalseOrNull(tagged))], // ensure null values evaluate to false\nlookupField:id, sourceField:dt.entity.host\n\n// filter for those that are not tagged\n| filter lookup.tagged == false \n| fieldsAdd `Untagged Host Name` = lookup.entity.name, total_hourly_cost\n| filter isNotNull(total_hourly_cost)\n// Get total spend for each\n| summarize `Cost per hour` = avg(total_hourly_cost), by:{`Untagged Host Name`}\n| sort `Cost per hour` desc\n| limit 20000","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualization":"table","visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxisLabel":"Untagged Host Name","valueAxisLabel":"Cost per hour"}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"Untagged Host Name"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"lineWrapIds":[],"columnWidths":{"[\"Untagged Host Name\"]":192.8203125,"[\"Cost per hour\"]":134.0625}}}},"5":{"type":"markdown","title":"","content":"## Selected tag $tagKey - coverage"},"6":{"type":"markdown","title":"","content":"---"},"8":{"type":"markdown","title":"","content":"## Coverage of all tags"},"9":{"type":"markdown","title":"","content":"## Spend per hour of unallocated hosts"},"10":{"type":"data","title":"Unallocated spend per hour","query":"fetch bizevents\n| filter event.type == \"instance.spend\"\n\n| lookup \n [fetch dt.entity.host\n | fieldsAdd tagged = contains(toString(tags), $tagKey)\n | fieldsAdd tagged = not(isFalseOrNull(tagged))],\nlookupField:id, sourceField:dt.entity.host\n\n| filter lookup.tagged == false\n\n// | fieldsAdd `dt.entity.host` = dt.entity.host, cost\n| summarize `Unallocated spend per day` = sum(total_hourly_cost), by:{bin(timestamp, 1m)}\n| limit 20000\n","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxisLabel":"Untagged Host Name","valueAxisLabel":"Total spend"},"colorPalette":"fireplace","legend":{"hidden":true},"fieldMapping":{"timestamp":"bin(timestamp, 1m)","leftAxisValues":["Unallocated spend per day"],"leftAxisDimensions":[]}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"Unallocated spend per day"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{},"lineWrapIds":[]}},"visualization":"lineChart"},"11":{"type":"markdown","title":"","content":"- The following dashboard shows the total costs that are currently unallocated because of hosts not tagged with the dt.owner\n- Action: ensure all hosts are tagged with a dt.owner tag pointing to the reposible team."},"12":{"type":"markdown","title":"","content":"---"},"13":{"type":"markdown","title":"","content":"- The following chart shows the most common tags across all hosts\n- This may be useful to setup Ownership"},"14":{"type":"data","title":"","query":"fetch dt.entity.host\n\n// add add field as \"true\" if host doen't contain tag\n| fieldsAdd Tag = contains(toString(tags), $tagKey)\n\n// temporary\n// | filter entity.name == \"ip-10-0-1-163.eu-west-1.compute.internal\"\n// | fields entity.name, id, Tag\n// hosts without the tag / total hosts\n| summarize `Percentage of hosts with tag` = (countIf(Tag) * 100) / count()\n","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualization":"singleValue","visualizationSettings":{"thresholds":[{"id":1,"field":"Percentage of hosts with tag","title":"","isEnabled":true,"rules":[{"id":0,"color":{"Default":"var(--dt-colors-charts-loglevel-emergency-default, #9033a3)"},"comparator":"<","label":"","value":5},{"id":1,"color":{"Default":"var(--dt-colors-charts-categorical-color-14-default, #d56b1a)"},"comparator":"≥","label":"","value":5},{"id":2,"color":{"Default":"var(--dt-colors-charts-categorical-color-09-default, #649438)"},"comparator":"≥","label":"","value":90}]}],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{}},"singleValue":{"showLabel":true,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","colorThresholdTarget":"value","recordField":"Percentage of hosts with tag"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"lineWrapIds":[],"columnWidths":{}},"unitsOverrides":[{"identifier":"Percentage of hosts with tag","unitCategory":"percentage","baseUnit":"percent","displayUnit":"percent","decimals":0,"suffix":"","delimiter":false,"added":1705063646979}]}},"15":{"type":"markdown","title":"","content":"- Ownership is key when it comes to costs. A host without an owner results in an unallocated cost.\n- The goal would be to increase the Percentage of hosts with chosen tags to a value near 100, to ensure every node has a team resposible for it.\n- The table next to the percentage is a list of all hosts without the $tagKey set up.\n- Total spend calculated the cost of the instance since the moment it started running."},"16":{"type":"data","title":"Unallocated spend per day","query":"fetch bizevents\n| filter event.type == \"instance.spend\"\n\n| lookup \n [fetch dt.entity.host\n | fieldsAdd tagged = contains(toString(tags), $tagKey)\n | fieldsAdd tagged = not(isFalseOrNull(tagged))],\nlookupField:id, sourceField:dt.entity.host\n\n| filter lookup.tagged == false\n\n// | fieldsAdd `dt.entity.host` = dt.entity.host, cost\n| summarize `Unallocated spend per day` = sum(total_hourly_cost)*24, by:{bin(timestamp, 1h)}\n| limit 20000\n","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxisLabel":"Untagged Host Name","valueAxisLabel":"Total spend"},"colorPalette":"fireplace","legend":{"hidden":true},"fieldMapping":{"timestamp":"bin(timestamp, 1h)","leftAxisValues":["Unallocated spend per day"],"leftAxisDimensions":[]}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"Unallocated spend per day"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{},"lineWrapIds":[]},"unitsOverrides":[{"identifier":"Unallocated spend per day","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":2,"suffix":"USD/day","delimiter":false,"added":1705571545661}]},"visualization":"singleValue"},"17":{"type":"data","title":"Unallocated spend per month","query":"fetch bizevents\n| filter event.type == \"instance.spend\"\n| lookup \n [fetch dt.entity.host\n | fieldsAdd tagged = contains(toString(tags), $tagKey)\n | fieldsAdd tagged = not(isFalseOrNull(tagged))],\nlookupField:id, sourceField:dt.entity.host\n| filter lookup.tagged == false\n// | fieldsAdd `dt.entity.host` = dt.entity.host, total_hourly_cost\n| summarize `Unallocated spend per week` = sum(total_hourly_cost)*24*7, by:{bin(timestamp, 1h)}\n| limit 20000\n","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxisLabel":"Untagged Host Name","valueAxisLabel":"Total spend"},"colorPalette":"fireplace","legend":{"hidden":true},"fieldMapping":{"timestamp":"bin(timestamp, 1h)","leftAxisValues":["Unallocated spend per week"],"leftAxisDimensions":[]}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"Unallocated spend per week"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{},"lineWrapIds":[]},"unitsOverrides":[{"identifier":"Unallocated spend per week","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":0,"suffix":"USD/month","delimiter":false,"added":1705571567837}]},"visualization":"singleValue"},"18":{"type":"data","title":"Unallocated spend per year","query":"fetch bizevents\n| filter event.type == \"instance.spend\"\n| lookup \n [fetch dt.entity.host\n | fieldsAdd tagged = contains(toString(tags), $tagKey)\n | fieldsAdd tagged = not(isFalseOrNull(tagged))],\nlookupField:id, sourceField:dt.entity.host\n| filter lookup.tagged == false\n// | fieldsAdd `dt.entity.host` = dt.entity.host, total_hourly_cost\n| summarize `Unallocated spend per year` = sum(total_hourly_cost)*24*7*52, by:{bin(timestamp, 1h)}\n| limit 20000\n","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxisLabel":"Untagged Host Name","valueAxisLabel":"Total spend"},"colorPalette":"fireplace","legend":{"hidden":true},"fieldMapping":{"timestamp":"bin(timestamp, 1h)","leftAxisValues":["Unallocated spend per year"],"leftAxisDimensions":[]}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"Unallocated spend per year"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{},"lineWrapIds":[]},"unitsOverrides":[{"identifier":"Unallocated spend per year","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":0,"suffix":"USD/year","delimiter":false,"added":1705571595925}]},"visualization":"singleValue"},"19":{"type":"data","title":"Unallocated spend per hour","query":"fetch bizevents\n| filter event.type == \"instance.spend\"\n\n| lookup \n [fetch dt.entity.host\n | fieldsAdd tagged = contains(toString(tags), $tagKey)\n | fieldsAdd tagged = not(isFalseOrNull(tagged))],\nlookupField:id, sourceField:dt.entity.host\n\n| filter lookup.tagged == false\n\n// | fieldsAdd `dt.entity.host` = dt.entity.host, total_hourly_cost\n| summarize `Unallocated spend per day` = sum(total_hourly_cost), by:{bin(timestamp, 1h)}\n| limit 20000\n","davis":{"enabled":false,"davisVisualization":{"isAvailable":true}},"visualizationSettings":{"thresholds":[],"chartSettings":{"gapPolicy":"connect","circleChartSettings":{"groupingThresholdType":"relative","groupingThresholdValue":0,"valueType":"relative"},"categoryOverrides":{},"categoricalBarChartSettings":{"categoryAxisLabel":"Untagged Host Name","valueAxisLabel":"Total spend"},"colorPalette":"fireplace","legend":{"hidden":true},"fieldMapping":{"timestamp":"bin(timestamp, 1h)","leftAxisValues":["Unallocated spend per day"],"leftAxisDimensions":[]}},"singleValue":{"showLabel":false,"label":"","prefixIcon":"","autoscale":true,"alignment":"center","recordField":"Unallocated spend per day"},"table":{"rowDensity":"condensed","enableSparklines":false,"hiddenColumns":[],"columnWidths":{},"lineWrapIds":[]},"unitsOverrides":[{"identifier":"Unallocated spend per day","unitCategory":"currency","baseUnit":"usd","displayUnit":null,"decimals":2,"suffix":"USD/hour","delimiter":false,"added":1705571450428}]},"visualization":"singleValue"}},"layouts":{"2":{"x":0,"y":25,"w":23,"h":6},"3":{"x":7,"y":3,"w":16,"h":6},"5":{"x":0,"y":0,"w":23,"h":1},"6":{"x":0,"y":21,"w":21,"h":1},"8":{"x":0,"y":22,"w":21,"h":1},"9":{"x":0,"y":9,"w":23,"h":1},"10":{"x":0,"y":12,"w":23,"h":6},"11":{"x":0,"y":10,"w":23,"h":2},"12":{"x":0,"y":31,"w":21,"h":1},"13":{"x":0,"y":23,"w":23,"h":2},"14":{"x":0,"y":3,"w":7,"h":6},"15":{"x":0,"y":1,"w":23,"h":2},"16":{"x":6,"y":18,"w":5,"h":3},"17":{"x":12,"y":18,"w":5,"h":3},"18":{"x":18,"y":18,"w":5,"h":3},"19":{"x":0,"y":18,"w":5,"h":3}}}